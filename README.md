# login.go README

## Overview

`login.go` is a command-line utility written in Go that helps you discover and SSH into AWS EC2 instances quickly. It supports:

- Listing EC2 instances by ID or Name tag
- Filtering by running or stopped state
- Starting stopped instances and waiting for them to become available
- SSH access using a local PEM key or fetching the key from AWS Secrets Manager

## Features

- **Instance Discovery**: Search by instance ID or partial Name tag, and optionally include stopped instances.
- **Automated Start**: If the selected instance is stopped, the tool will start it and wait until it's running.
- **Flexible Key Management**: Choose between using a local `~/.ssh/*.pem` file or securely retrieving your private key from AWS Secrets Manager.
- **Secure Cleanup**: Temporary files created when pulling keys from Secrets Manager are permission‑locked and removed after use.

## Prerequisites

- Go 1.18 or later
- AWS credentials configured (via `~/.aws/credentials`, environment variables, or IAM role)
- AWS SDK for Go v2 installed
- Permissions to call:
  - `ec2:DescribeInstances`, `ec2:StartInstances`, `ec2:DescribeInstances` (for the waiter)
  - `secretsmanager:GetSecretValue` (if using Secrets Manager for PEM retrieval)

## Installation

1. Clone this repository or download `login.go`.

   ```bash
   git clone https://github.com/your-org/your-repo.git
   cd your-repo
   ```

2. Build the binary:

   ```bash
   go build -o login login.go
   ```

3. (Optional) Move it into your `PATH`:

   ```bash
   mv login /usr/local/bin/
   ```

## Usage

Run the tool and follow the prompts:

```bash
./login
```

1. **Include stopped instances?** Type `yes` or `no`.
2. **Search by Instance ID?** Type `yes` to search by ID, `no` to search by Name tag.
3. **Enter the search term** (Instance ID or part of Name).
4. **Select an instance** from the displayed list.
5. **Fetch SSH key from AWS Secrets Manager?** Type `yes` to pull the PEM from Secrets Manager, or `no` to use your local `~/.ssh/*.pem` file.
6. The tool will then SSH into the instance as `ec2-user`.

Example:

```text
Include stopped instances? (yes/no): no
Search by Instance ID? (yes/no): no
Enter the search term (ID or name): webserver
1) Name: webserver-prod, Instance ID: i-0123456789abcdef0, State: running
Enter the number of the instance to log into: 1
Fetch SSH key from AWS Secrets Manager? (yes/no): yes
# SSH session starts...
```

## Secrets Manager Setup

To use the Secrets Manager feature, create a secret whose **name exactly matches** your EC2 Key Pair name. Store the private key (`.pem` contents) as the secret value (either string or binary).

```bash
aws secretsmanager create-secret \
  --name MyKeyPairName \
  --secret-string "$(<~/.ssh/MyKeyPairName.pem)"
```

Ensure your IAM role or user has permission to `GetSecretValue` on that secret.

## Configuration

- **AWS Region**: Controlled by the usual AWS environment variables (`AWS_REGION`) or `~/.aws/config`.
- **SSH User**: Hardcoded to `ec2-user`. Modify `sshIntoInstance` if you need a different user.
- **SSH Options**: You can tweak the `ssh` command flags in `sshIntoInstance` (e.g., add `-i` options or custom `-o`).

## Security Considerations

- Temporary key files from Secrets Manager are created with `0600` permissions and deleted immediately after use.
- Be cautious when storing private keys in Secrets Manager: follow your organization’s key rotation and audit policies.

## Troubleshooting

- **Cannot read SSH directory**: Ensure `~/.ssh` exists and is readable.
- **No matching key found**: Verify your local filenames or that the secret name matches the Key Pair name.
- **Permission errors**: Confirm your AWS credentials and IAM permissions.

## License

This project is licensed under the MIT License. See [LICENSE](LICENSE) for details.

---

*Generated by Alan’s EC2 login utility*
